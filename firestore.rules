/**
 * @fileoverview Firestore Security Rules for the Exam application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for student data and path-based authorization for exams and questions.
 * Only authenticated users can access their own student data, and exams/questions are publicly readable but only modifiable with appropriate authorization (not implemented).
 *
 * Data Structure:
 * - /exams/{examId}: Stores exam metadata.
 * - /exams/{examId}/questions/{questionId}: Stores questions for each exam.
 * - /students/{studentId}: Stores student profiles.
 * - /students/{studentId}/responses/{responseId}: Stores student responses.
 *
 * Key Security Decisions:
 * - Students can only create, read, update, and delete their own profiles and responses.
 * - Exams and questions are publicly readable. Write operations require a separate access control mechanism (e.g., admin roles) which are not yet implemented.
 * - Listing of student responses is restricted to the owning student.
 * - Denormalization is used to associate responses with students via the path, simplifying authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to the /exams collection.
     * @path /exams/{examId}
     * @allow get, list: if true
     * @allow create: if false
     * @allow update: if false
     * @allow delete: if false
     * @deny create: if true, because write access is not permitted to all users.
     * @principle Public read, owner-only writes (writes not yet implemented - requires authorization).
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add authorization mechanism for creating/modifying exams (e.g., admin role).
    }

    /**
     * @description Controls access to the /exams/{examId}/questions collection.
     * @path /exams/{examId}/questions/{questionId}
     * @allow get, list: if true
     * @allow create: if false
     * @allow update: if false
     * @allow delete: if false
     * @deny create: if true, because write access is not permitted to all users.
     * @principle Public read, owner-only writes (writes not yet implemented - requires authorization).
     */
    match /exams/{examId}/questions/{questionId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add authorization mechanism for creating/modifying questions (e.g., admin role).
    }

    /**
     * @description Controls access to the /students collection.
     * @path /students/{studentId}
     * @allow get: if isOwner(studentId);
     * @allow create: if isOwner(studentId);
     * @allow update: if isExistingOwner(studentId);
     * @allow delete: if isExistingOwner(studentId);
     * @allow list: if false;
     * @deny create: if request.auth.uid != request.resource.data.id;
     * @deny update: if request.resource.data.id != resource.data.id;
     * @principle Enforces document ownership for writes.
     */
    match /students/{studentId} {
      allow get: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isExistingOwner(studentId) && (request.resource.data.id == resource.data.id);
      allow delete: if isExistingOwner(studentId);
      allow list: if false;
    }

    /**
     * @description Controls access to the /students/{studentId}/responses collection.
     * @path /students/{studentId}/responses/{responseId}
     * @allow get: if isOwner(studentId);
     * @allow create: if isOwner(studentId);
     * @allow update: if isExistingOwner(studentId);
     * @allow delete: if isExistingOwner(studentId);
     * @allow list: if isOwner(studentId);
     * @deny create: if request.auth.uid != request.resource.data.studentId;
     * @deny update: if request.resource.data.studentId != resource.data.studentId;
     * @principle Enforces document ownership for writes.
     */
    match /students/{studentId}/responses/{responseId} {
      allow get: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
      allow list: if isOwner(studentId);
    }
  }

  /**
   * @description Checks if the user is signed in.
   * @return {boolean} True if the user is signed in, false otherwise.
   */
  function isSignedIn() {
    return request.auth != null;
  }

  /**
   * @description Checks if the user is the owner of the document.
   * @param {string} userId The user ID to check against.
   * @return {boolean} True if the user is the owner, false otherwise.
   */
  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  /**
   * @description Checks if the user is the owner of the document and the document exists.
   * @param {string} userId The user ID to check against.
   * @return {boolean} True if the user is the owner and the document exists, false otherwise.
   */
  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}